{% extends 'layout.html' %}
{% load staticfiles %}
{% load format_names %}
{% load url_generate %}
{% load url_replace %}

{% block title %}Builds - {{ port.name }} |{% endblock %}

{% block head_scripts %}
    <script type="text/javascript" src="{% static 'js/port-detail.js' %}"></script>
{% endblock %}

{% block content %}
    <div id="main-content" class="mt-2">
    {% include 'port/includes/port-header.html' with port=port %}
    {% include 'port/includes/port-tabs.html' with port_name=port.name active="builds" %}
<br>
<form method="get" action=".">
<div class="form-row">
    <div class="col-lg-4">
        <label for="status-filter">Filter based on Status: </label>
        <select onchange="this.form.submit()" class="form-control ml-2 filter" id="status" name="status">
            <option value="">All</option>
            <option value="build successful" {% if status == "build successful" %}selected{% endif %}>Successful Builds</option>
            <option value="failed" {% if status == "failed" %}selected{% endif %}>All Failed Builds</option>
            <option value="failed install-port" {% if status == "failed install-port" %}selected{% endif %}>failed install-port</option>
            <option value="failed install-dependencies" {% if status == "failed install-dependencies" %}selected{% endif %}>failed install-dependencies</option>
        </select>
    </div>
    <div class="col-lg-4">
        <label for="builder-filter">Filter based on builder: </label>
        <select onchange="this.form.submit()" class="form-control ml-2 filter" id="builder_name__display_name" name="builder_name__display_name">
            <option value="">All</option>
            {% for builder_option in builders_list %}
                <option value="{{ builder_option }}" {%  if builder == builder_option %}selected{% endif %}>{{ builder_option }}</option>
            {% endfor %}
        </select>
    </div>
</div>
</form>
<br><br>
{% if builds|length > 0 %}
<h4 class="text-secondary">Showing {% if status == "" %} <ins>All Builds</ins> {% else %}builds with status: <ins>{{ status }}</ins>{% endif %} on <ins>{% if builder == "" %}All Builders {% else %}{{ builder }}{% endif %}</ins></h4>

{% if builds.has_other_pages %}
            Page {{ builds.number }} of {{ builds.paginator.num_pages }} | Showing builds {{ builds.start_index }} to
            {{ builds.end_index }}<br><br>
            <nav aria-label="Page navigation">
                <ul class="pagination">
                    {% if builds.has_previous %}
                        <li class="page-item"><a class="page-link" href="?{% url_replace page=builds.previous_page_number %}">&laquo;</a></li>
                    {% else %}
                        <li class="disabled page-item"><span class="page-link">&laquo;</span></li>
                    {% endif %}

                    {% if builds.number|add:'-4' > 1 %}
                        <li class="page-item"><a class="page-link" href="?{% url_replace page=page.builds.number|add:'-5' %}">&hellip;</a>
                        </li>
                    {% endif %}

                    {% for i in builds.paginator.page_range %}
                        {% if builds.number == i %}
                            <li class="active page-item"><span class="page-link">{{ i }} <span
                                    class="sr-only">(current)</span></span></li>
                        {% elif i > builds.number|add:'-5' and i < builds.number|add:'5' %}
                            <li class="page-item"><a class="page-link" href="?{% url_replace page=i %}">{{ i }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if builds.paginator.num_pages > builds.number|add:'4' %}
                        <li class="page-item"><a class="page-link" href="?{% url_replace page=builds.number|add:'5' %}">&hellip;</a>
                        </li>
                    {% endif %}

                    {% if builds.has_next %}
                        <li class="page-item"><a class="page-link" href="?{% url_replace page=builds.next_page_number %}">&raquo;</a>
                        </li>
                    {% else %}
                        <li class="disabled page-item"><span class="page-link">&raquo;</span></li>
                    {% endif %}
                </ul>
            </nav>
{% endif %}
<table class="table table-striped">
    <thead>
    <tr>
        <th scope="col">Builder</th>
        <th scope="col">Build Number</th>
        <th scope="col">Start Time</th>
        <th scope="col">Elapsed Time</th>
        <th scope="col">Watcher</th>
        <th scope="col">Build Status</th>
    </tr>
    </thead>
    {% for build in builds %}
        <tr>
            <td>{{ build.builder_name.display_name }}</td>
            <td><a target="_blank" href="{% build_url build.builder_name.name build.build_id %}">{{ build.build_id }}</a></td>
            <td>{{ build.time_start|date:"Y-m-d" }}  {{ build.time_start|time:"G:i:s" }} </td>
            <td>{{ build.time_elapsed }}</td>
            <td><a target="_blank" href="{% watcher_url build.builder_name.name build.watcher_id %}">{{ build.watcher_id }}</a></td>
            <td class="{% if build.status == 'build successful' %}text-success {% else %} text-danger {% endif %}">{{ build.status }}</td>
        </tr>
    {% endfor %}
</table>
{% else %}
<div class="text-center container" style="max-width: 700px;">
    <h5>No build history is available for that selection right now.</h5>
    <p>This does not mean that there is anything wrong with builds. It is just that the app does not have
        any records in its database. It may be caused by a failure to fetch the history in time.</p>
</div>
{% endif %}
</div>
{% endblock %}
